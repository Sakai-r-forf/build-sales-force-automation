{% extends "dashboard/base.html" %} {% block title %}企業情報一覧{% endblock %}
{% block head %}
<link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/dashboard/companies/index.css') }}"
/>
{% endblock %} {% block content %}

<div class="companies-page">
    <div class="search-container">
        <div class="search-wrapper">
            <div class="search-content">
                <input
                    type="text"
                    id="search-input"
                    placeholder="企業名で検索"
                    class="search-input"
                />
                <div class="search-divider"></div>
                <button id="search-btn" type="button">
                    <img src="/static/auth/image/favicon/favicon.png" alt="検索" />
                </button>
            </div>
        </div>
    </div>
    
    <div class="company-list-container">
        <div class="company-list-wrapper">
            <div class="company-list-content">
                <table class="companies-table">
                    <colgroup>
                        <col />
                        <col />
                        <col />
                        <col />
                        <col />
                        <col />            
                    </colgroup>
                    <thead>
                        <tr>
                        <th class="mailStatus">メール</br>送付有無</th>
                        <th class="id">ID</th>
                        <th class="companyName">企業名</th>
                        <th class="companySite">企業HP</th>
                        <th class="inquiryUrl">お問い合わせURL</th>
                        <th class="savedDate">保存日</th>
                        </tr>
                    </thead>
                    
                    <tbody id="companies-tbody">
                        {% for c in companies %}
                        <tr>
                            <td class="mailStatus">×</td>
                            <td class="id">{{ c.id }}</td>
                            <td class="companyName">{{ c.company_name or '' }}</td>
                            <td class="companySite">
                                {% if c.company_site %}
                                <a href="{{ c.company_site }}" target="_blank">{{ c.company_site }}</a>
                                {% endif %}
                            </td>
                            <td class="inquiryUrl">
                                {% if c.inquiry_url %}
                                <a href="{{ c.inquiry_url }}" target="_blank">{{ c.inquiry_url }}</a>
                                {% endif %}
                            </td>
                            <td class="savedDate">{{ c.created_at.strftime('%Y/%m/%d') if c.created_at else '' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    
                    
                </table>
            </div>
        </div>
    </div>

    <div class="pagination-list-container">
        <div class="pagination-list-wrapper">
            <div class="pagination-list-content">
                <nav class="pager">
                    {% if pagination.has_prev %}
                    <a class="search-list-pagination pager-btn" href="?page={{ pagination.prev_num }}">&lt; 前へ</a>
                    {% endif %}
    
                    {% for p in range(1, pagination.pages + 1) %}
                        {% if p == pagination.page %}
                            <span class="current">{{ p }}</span>
                        {% else %}
                            <a class="search-list-pagination" href="?page={{ p }}">{{ p }}</a>
                        {% endif %}
                    {% endfor %}
    
                    {% if pagination.has_next %}
                    <a class="search-list-pagination pager-btn" href="?page={{ pagination.next_num }}">次へ &gt;</a>
                    {% endif %}
                </nav>
            </div>
        </div>
    </div>
    <!--
    <div class="pagination-list-container">
        <div class="pagination-list-wrapper">
            <div class="pagination-list-content">
                <nav
                class="pager"
                id="companies-pager"
                aria-label="ページ切替"
                ></nav>
            </div>
        </div>
    </div>
　  -->

    <div class="page-top-container">
        <div class="page-top-wrapper">
            <div class="page-top-content" id="pageTopBtn">
                <img src="/static/auth/image/page-top-button.png" />
            </div>
        </div>
    </div>
</div>

<!-- TODO: 仮グラフをJSで作成済み。現行の機能に加え以下追加実装もPythonで再実装をお願いいたします。 -->

<!-- 現行実装 -->
<!-- 1. 表全体: 表内の値は配列で表示 -->

<!-- TODO: 追加実装 -->
<!-- TODO: 3. メール送付有無: チェックボックス実装、営業メール自動送付済みの場合はチェックが付く -->
<!-- TODO: 4. ID: DBからID表示をする実装 -->
<!-- TODO: 7. 保存日: DB格納年月日を表示する実装 -->

<script>
    /*
    const pages = Array.from({ length: 50 }, (_, pageIndex) => {
        return [
            {
                mailStatus: false,
                id: "1234",
                companyName: "株式会社創伸建設〇〇株式会社創伸建設〇〇株式会社創伸建設...",
                companySite: "https://k-soushsoush...",
                inquiryUrl: "https://k-soushsoush...",
                savedDate: "yyyy/mm/dd",
            },
            ...Array.from({ length: 99 }, () => ({
                mailStatus: false,
                id: "",
                companyName: "",
                companySite: "",
                inquiryUrl: "",
                savedDate: "",
            }))
        ];
    });
    */
    function formatCompanyName(text) {
        if (!text) return "";
        const chars = Array.from(text);
        const first = chars.slice(0, 10).join("");
        let second = chars.slice(10, 20).join("");
        if (chars.length > 20) {
            second += "…";
        }
        return second ? `${first}<br>${second}` : first;
    }

    function formatURL(text) {
        if (!text) return "";
        const chars = Array.from(text);
        if (chars.length > 15) {
            return chars.slice(0, 15).join("") + "…";
        }
        return text;
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("td.companyName").forEach(td => {
            const raw = td.textContent.trim();
            td.innerHTML = formatCompanyName(raw);
        });

        document.querySelectorAll("td.companySite a").forEach(a => {
            const raw = a.textContent.trim();
            a.textContent = formatURL(raw);
        });

        document.querySelectorAll("td.inquiryUrl a").forEach(a => {
            const raw = a.textContent.trim();
            a.textContent = formatURL(raw);
        });
    });

    function renderTable() {
        tbody.innerHTML = "";
        pages[page - 1].forEach(company => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${company.mailStatus}</td>
                <td>${company.id}</td>
                <td>${formatCompanyName(company.companyName)}</td>
                <td>${formatURL(company.companySite)}</td>
                <td>${formatURL(company.inquiryUrl)}</td>
                <td>${company.savedDate}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    const rowHTML = (r, index) =>
        `<tr>
            <td class="mailStatus">
                <input type="checkbox" id="chk_${page}_${index}" ${r.mailStatus ? "checked" : ""}>
            </td>
            <td class="id">${r.id || ""}</td>
            <td class="companyName">${formatCompanyName(r.companyName || "")}</td>
            <td class="companySite"><a href="${r.companySite || "#"}" target="_blank">${formatURL(r.companySite || "")}</a></td>
            <td class="inquiryUrl"><a href="${r.inquiryUrl || "#"}" target="_blank">${formatURL(r.inquiryUrl || "")}</a></td>
            <td class="savedDate">${r.savedDate || ""}</td>
        </tr>`;

    /*
    function renderTable(pageNum) {
        const rows = pages[pageNum - 1] ?? [];
        tbody.innerHTML = "";
        rows.forEach((row, i) => {
            const rowData = {
                ...row,
                companyName: row.companyName,
                companySite: row.companySite,
                inquiryUrl: row.inquiryUrl
            };
            tbody.insertAdjacentHTML("beforeend", rowHTML(rowData, i));
        });
    }

    function buildPagerHTML(pageNum, total) {
        const parts = [];
        if (pageNum > 1)
            parts.push(`<a class="search-list-pagination pager-btn" data-page="${pageNum - 1}" href="#top">< 前へ</a>`);
        for (let p = 1; p <= total; p++) {
            const isNearStart = pageNum <= 3 && p <= 5;
            const isNearEnd = pageNum >= total - 2 && p >= total - 4;
            const inWindow = p === 1 || p === total || (p >= pageNum - 2 && p <= pageNum + 2);
            if (isNearStart || isNearEnd || inWindow) {
                parts.push(p === pageNum
                    ? `<span class="current">${p}</span>`
                    : `<a class="search-list-pagination" data-page="${p}" href="#top">${p}</a>`
                );
            } else if (p === 2 && pageNum > 4) {
                parts.push(`<span class="dots">...</span>`);
            } else if (p === total - 1 && pageNum < total - 3) {
                parts.push(`<span class="dots">...</span>`);
            }
        }
        if (pageNum < total)
            parts.push(`<a class="search-list-pagination pager-btn" data-page="${pageNum + 1}" href="#top">次へ ></a>`);
        return parts.join("");
    }

    function renderPager() {
        pagerEl.innerHTML = buildPagerHTML(page, totalPages);
    }
    */

    document.addEventListener("change", (e) => {
        if (e.target.matches(".mailStatus input[type='checkbox']")) {
            const [_, p, i] = e.target.id.split("_");
            pages[p - 1][i].mailStatus = e.target.checked;
        }
    });

    pagerEl.addEventListener("click", (e) => {
        const a = e.target.closest(".search-list-pagination");
        if (!a) return;
        const to = Number(a.dataset.page);
        if (!Number.isFinite(to) || to < 1 || to > totalPages) return;
        page = to;
        renderTable(page);
        renderPager();
    });

    renderPager();
    renderTable(page);
</script>
<script>
    const searchInput = document.getElementById("search-input");
    const searchBtn = document.getElementById("search-btn");

    function searchCompaniesAllPages() {
        const query = searchInput.value.trim().toLowerCase();
        if (!query) {

            renderTable(page);
            renderPager();
            return;
        }

        const allData = pages.flat();
        const filtered = allData.filter(row => row.companyName.toLowerCase().includes(query));

        tbody.innerHTML = "";
        filtered.forEach((row, i) => {
            const truncatedRow = { ...row, companyName: truncateTo20(row.companyName) };
            tbody.insertAdjacentHTML("beforeend", rowHTML(truncatedRow, i));
        });

        pagerEl.innerHTML = "";
    }

    searchBtn.addEventListener("click", searchCompaniesAllPages);

    searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            searchCompaniesAllPages();
        }
    });
</script>

<script>
    const pageTopBtn = document.getElementById("pageTopBtn");

    pageTopBtn.addEventListener("click", () => {
        window.scrollTo({
            top: 0,
            behavior: "smooth"
        });
    });
</script>
{% endblock %}
