{% extends "dashboard/base.html" %} {% block title %}企業情報一覧{% endblock %}
{% block head %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/dashboard/companies/index.css') }}"
/>
{% endblock %} {% block content %}

<div class="companies-page">
    <div class="search-container">
        <div class="search-wrapper">
            <div class="search-content">
                <input
                    type="text"
                    id="search-input"
                    placeholder="企業名で検索"
                    class="search-input"
                />
                <div class="search-divider"></div>
                <button id="search-btn" type="button">
                    <img src="/static/auth/image/favicon/favicon.png" alt="検索" />
                </button>
            </div>
        </div>
    </div>
    
    <div class="company-list-container">
        <div class="company-list-wrapper">
            <div class="company-list-content">
                <table class="companies-table">
                    <colgroup>
                        <col />
                        <col />
                        <col />
                        <col />
                        <col />
                        <col />            
                    </colgroup>
                    <thead>
                        <tr>
                        <th class="mailStatus">メール</br>送付有無</th>
                        <th class="id">ID</th>
                        <th class="companyName">企業名</th>
                        <th class="companySite">企業HP</th>
                        <th class="inquiryUrl">お問い合わせURL</th>
                        <th class="savedDate">保存日</th>
                        </tr>
                    </thead>
                    
                    <tbody id="companies-tbody"></tbody>
                    
                </table>
            </div>
        </div>
    </div>

    <div class="pagination-list-container">
        <div class="pagination-list-wrapper">
            <div class="pagination-list-content">
                <nav
                class="pager"
                id="companies-pager"
                aria-label="ページ切替"
                ></nav>
            </div>
        </div>
    </div>

    <div class="page-top-container">
        <div class="page-top-wrapper">
            <div class="page-top-content" id="pageTopBtn">
                <img src="/static/auth/image/page-top-button.png" />
            </div>
        </div>
    </div>
</div>


<script>
    const pages = Array.from({ length: 50 }, (_, pageIndex) => {
        return [
            {
                mailStatus: false,
                id: "1234",
                companyName: "株式会社創伸建設〇〇株式会社創伸建設〇〇株式会社創伸建設...",
                companySite: "https://k-soush...",
                inquiryUrl: "https://k-soush...",
                savedDate: "yyyy/mm/dd",
            },
            // 残り99件を空データとして生成
            ...Array.from({ length: 99 }, () => ({
                mailStatus: false,
                id: "",
                companyName: "",
                companySite: "",
                inquiryUrl: "",
                savedDate: "",
            }))
        ];
    });
    const tbody = document.getElementById("companies-tbody");
    const pagerEl = document.getElementById("companies-pager");
    let page = 1;
    const totalPages = pages.length;

    function truncateTo20(str) {
        let chars = Array.from(str);
        if (chars.length > 20) {
            return chars.slice(0, 20).join('') + '…';
        }
        return str;
    }
    const rowHTML = (r, index) =>
        `<tr>
            <td class="mailStatus">
                <input type="checkbox" id="chk_${page}_${index}" ${r.mailStatus ? "checked" : ""}>
            </td>
            <td class="id">${r.id || ""}</td>
            <td class="companyName">${r.companyName || ""}</td>
            <td class="companySite"><a href="${r.companySite || "#"}" target="_blank">${r.companySite || ""}</a></td>
            <td class="inquiryUrl"><a href="${r.inquiryUrl || "#"}" target="_blank">${r.inquiryUrl || ""}</a></td>
            <td class="savedDate">${r.savedDate || ""}</td>
        </tr>`;
    
    // テーブル描画（truncate適用）
    function renderTable(pageNum) {
        const rows = pages[pageNum - 1] ?? [];
        tbody.innerHTML = "";
        rows.forEach((row, i) => {
            const truncatedRow = { ...row, companyName: truncateTo20(row.companyName) };
            tbody.insertAdjacentHTML("beforeend", rowHTML(truncatedRow, i));
        });
    }
    
    // ページャー生成
    function buildPagerHTML(pageNum, total) {
        const parts = [];
        if (pageNum > 1)
            parts.push(`<a class="search-list-pagination pager-btn" data-page="${pageNum - 1}" href="#top">< 前へ</a>`);
        for (let p = 1; p <= total; p++) {
            const isNearStart = pageNum <= 3 && p <= 5;
            const isNearEnd = pageNum >= total - 2 && p >= total - 4;
            const inWindow = p === 1 || p === total || (p >= pageNum - 2 && p <= pageNum + 2);
            if (isNearStart || isNearEnd || inWindow) {
                parts.push(p === pageNum
                    ? `<span class="current">${p}</span>`
                    : `<a class="search-list-pagination" data-page="${p}" href="#top">${p}</a>`
                );
            } else if (p === 2 && pageNum > 4) {
                parts.push(`<span class="dots">...</span>`);
            } else if (p === total - 1 && pageNum < total - 3) {
                parts.push(`<span class="dots">...</span>`);
            }
        }
        if (pageNum < total)
            parts.push(`<a class="search-list-pagination pager-btn" data-page="${pageNum + 1}" href="#top">次へ ></a>`);
        return parts.join("");
    }
    
    // ページャー描画
    function renderPager() {
        pagerEl.innerHTML = buildPagerHTML(page, totalPages);
    }
    
    document.addEventListener("change", (e) => {
        if (e.target.matches(".mailStatus input[type='checkbox']")) {
            const [_, p, i] = e.target.id.split("_");
            pages[p - 1][i].mailStatus = e.target.checked;
        }
    });
    
    pagerEl.addEventListener("click", (e) => {
        const a = e.target.closest(".search-list-pagination");
        if (!a) return;
        const to = Number(a.dataset.page);
        if (!Number.isFinite(to) || to < 1 || to > totalPages) return;
        page = to;
        renderTable(page);
        renderPager();
    });
    
    // 初期描画
    renderPager();
    renderTable(page);
</script>

<script>
    const searchInput = document.getElementById("search-input");
    const searchBtn = document.getElementById("search-btn");

    function searchCompaniesAllPages() {
        const query = searchInput.value.trim().toLowerCase();
        if (!query) {

            renderTable(page);
            renderPager();
            return;
        }

        const allData = pages.flat();
        const filtered = allData.filter(row => row.companyName.toLowerCase().includes(query));

        tbody.innerHTML = "";
        filtered.forEach((row, i) => {
            const truncatedRow = { ...row, companyName: truncateTo20(row.companyName) };
            tbody.insertAdjacentHTML("beforeend", rowHTML(truncatedRow, i));
        });

        pagerEl.innerHTML = "";
    }

    searchBtn.addEventListener("click", searchCompaniesAllPages);

    searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            searchCompaniesAllPages();
        }
    });
</script>

<script>
    const pageTopBtn = document.getElementById("pageTopBtn");

    pageTopBtn.addEventListener("click", () => {
        window.scrollTo({
            top: 0,
            behavior: "smooth" // ぬるっとスクロール
        });
    });
</script>
{% endblock %}
